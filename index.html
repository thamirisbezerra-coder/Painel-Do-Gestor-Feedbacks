<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão de Feedbacks (v2)</title>
    <!-- Scripts e Estilos permanecem os mesmos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .notification-card { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        canvas { cursor: pointer; }
        .feedback-sample-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            transition: background-color: 0.2s;
        }
        .feedback-sample-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .feedback-sample-item.highlight {
            background-color: #fffbeb; /* bg-amber-50 */
        }
        .manager-reply, .seller-reply {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #d1d5db; /* gray-300 */
            font-size: 0.8rem;
            color: #4b5563; /* gray-600 */
        }
        .seller-reply {
            padding-left: 0.5rem;
            border-left: 2px solid #fdba74; /* orange-300 */
            background-color: #fffbeb; /* amber-50 */
            padding-bottom: 0.5rem;
            border-top: 1px dashed #fed7aa; /* orange-200 */
        }
        .pd-postit-card {
            background-color: #fffbeb; /* bg-amber-50 */
            border: 1px solid #fde68a; /* border-amber-200 */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
        }
         .label-saving {
            color: #a78bfa; /* text-purple-600 */
            font-weight: 600; /* font-semibold */
            animation: pulse 1.5s infinite;
         }
         @keyframes pulse {
             0%, 100% { opacity: 1; }
             50% { opacity: 0.6; }
         }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="p-2 bg-blue-100 rounded-full">
                    <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Painel de Gestão (v2)</h1>
            </div>
            <div class="flex items-center space-x-4">
                 <p id="session-id-text" class="text-sm text-gray-500">A conectar...</p>
                 <button id="notifications-permission-btn" title="Gerir permissões de notificação">
                     <svg id="bell-icon" class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                 </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 md:p-8">
        
        <div id="connection-section" class="text-center mb-8 p-4 bg-white rounded-lg shadow-sm">
             <p id="info-message" class="text-lg font-semibold text-gray-700">A procurar sessão ativa...</p>
         </div>

        <div id="dashboard" class="hidden">
            
            <section id="acesso-rapido-section" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 1. Painel Gerentes -->
                <a href="https://thamirisbezerra-coder.github.io/PainelGerencia/" target="_blank"
                   class="block bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition hover:-translate-y-1">
                    <div class="flex items-center mb-3">
                        <svg class="w-8 h-8 mr-3 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002 2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        <h3 class="text-xl font-bold text-gray-800">Painel Gerentes</h3>
                    </div>
                    <p class="text-sm text-gray-600">Sua senha de Gestor para este painel é:</p>
                    <p class="text-lg font-mono font-bold text-red-600 my-2 bg-gray-100 p-2 rounded text-center">admin123</p>
                    <p class="text-xs text-gray-500 mt-1">Senhas dos gerentes estão disponíveis 
                        <button type="button" id="open-senhas-gerentes-btn" class="text-blue-600 font-semibold hover:underline focus:outline-none">aqui</button>.
                    </p>
                    <div class="text-right mt-2 text-sm font-semibold text-blue-600">Clique para abrir &rarr;</div>
                </a>

                <!-- 2. Painel Vendedores -->
                <a href="https://thamirisbezerra-coder.github.io/Tela-do-Vendedor/" target="_blank"
                   class="block bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition hover:-translate-y-1">
                    <div class="flex items-center mb-3">
                         <svg class="w-8 h-8 mr-3 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <h3 class="text-xl font-bold text-gray-800">Tela do Vendedor</h3>
                    </div>
                    <p class="text-sm text-gray-600">Este é o link que os vendedores acessarão para inserir seus feedbacks.</p>
                    <p class="text-xs text-gray-500 mt-1">(Não precisam mais do ID da Sessão, apenas Nome e Código).</p>
                    <div class="text-right mt-3 text-sm font-semibold text-blue-600">Clique para abrir &rarr;</div>
                </a>
                
                <!-- 3. Painel P&D -->
                <a href="https://thamirisbezerra-coder.github.io/Painel-Pesquisa-e-Desenvolvimento/" target="_blank"
                   class="block bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition hover:-translate-y-1">
                    <div class="flex items-center mb-3">
                         <svg class="w-8 h-8 mr-3 text-blue-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                         </svg>
                        <h3 class="text-xl font-bold text-gray-800">Painel P&D</h3>
                    </div>
                    <p class="text-sm text-gray-600">Sua senha de Gestor para este painel é:</p>
                    <p class="text-lg font-mono font-bold text-red-600 my-2 bg-gray-100 p-2 rounded text-center">admin123</p>
                    <p class="text-xs text-gray-500 mt-1">Senhas de P&D estão disponíveis 
                        <button type="button" id="open-senhas-pd-btn" class="text-blue-600 font-semibold hover:underline focus:outline-none">aqui</button>.
                    </p>
                    <div class="text-right mt-2 text-sm font-semibold text-blue-600">Clique para abrir &rarr;</div>
                </a>
            </section>
            
            <section id="painel-resultados-section" class="mb-8">
                <a href="https://thamirisbezerra-coder.github.io/Painel-de-Resultados/" target="_blank" 
                   class="block bg-blue-600 text-white p-6 rounded-2xl shadow-lg border border-blue-700 hover:bg-blue-700 transition transform hover:-translate-y-1 md:max-w-4xl mx-auto">
                    <div class="flex items-center mb-3">
                        <svg class="w-8 h-8 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h3 class="text-xl font-bold">Resultados 2023x2024x2025</h3>
                    </div>
                    <p class="text-sm text-blue-100">Contém o <strong>Ranking de Aromas (DAR)</strong>.</p>
                    <div class="text-right mt-2 text-sm font-semibold text-blue-200">Clique para abrir &rarr;</div>
                </a>
            </section>

            <!-- Notifications -->
            <section id="notifications-section" class="mb-8 max-w-4xl mx-auto">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-bold text-gray-900">Notificações</h2>
                     <button id="history-btn" class="bg-gray-200 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Histórico</button>
                 </div>
                 <div id="notifications-list" class="space-y-3"><p class="text-gray-500 placeholder-notification">Nenhuma notificação nova.</p></div>
            </section>

            <!-- Charts -->
            <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="font-bold text-lg mb-2 text-center">Status da Sessão</h3><div style="height: 250px;"><canvas id="session-status-chart"></canvas></div></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="font-bold text-lg mb-2 text-center" id="rejection-chart-title">Distribuição de Feedbacks</h3><div style="height: 250px;"><canvas id="rejection-rate-chart"></canvas></div></div>
            </section>

            <!-- Feedback Details -->
            <section id="feedback-details-section" class="mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Análise de Respostas</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="font-bold text-lg mb-3 text-green-600">Aprovados</h3>
                        <ul id="approved-feedback-list" class="space-y-1 text-sm"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="font-bold text-lg mb-3 text-red-600">Reprovados</h3>
                        <ul id="rejected-feedback-list" class="space-y-1 text-sm"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="font-bold text-lg mb-3 text-purple-600">Eventos</h3>
                        <ul id="events-feedback-list" class="space-y-1 text-sm"></ul>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="font-bold text-lg mb-3 text-amber-600">Pendência</h3>
                        <ul id="pending-feedback-list" class="space-y-1 text-sm"></ul>
                    </div>
                </div>
            </section>

            <!-- FEEDS LADO A LADO -->
            <section class="grid grid-cols-1 md:grid-cols-2 md:items-start gap-6 mb-10">
                <!-- Coluna Feed Vendedores -->
                <section id="observations-feed-section">
                     <h2 class="text-2xl font-bold text-gray-900 mb-4">Feed de Observações (Vendedores)</h2>
                     <div class="mb-4 space-y-2 min-h-24">
                         <select id="observation-segment-filter" class="border-gray-300 rounded-lg shadow-sm text-sm w-full">
                             <option value="">Todos os Segmentos</option>
                         </select>
                         <input id="observation-search-input" type="text" placeholder="Pesquisar por vendedor..." class="border-gray-300 rounded-lg shadow-sm text-sm w-full">
                     </div>
                     <div id="observations-feed-list" class="space-y-4 h-96 overflow-y-auto bg-white p-4 rounded-2xl shadow-sm border">
                         <p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada com os filtros atuais.</p>
                     </div>
                </section>

                <!-- Coluna Post-its P&D -->
                <section id="pd-postits-section">
                     <h2 class="text-2xl font-bold text-gray-900 mb-4">Post-its do P&D (Notas Internas)</h2>
                     <div class="mb-4 space-y-2 min-h-24">
                         <select id="pd-postit-segment-filter" class="border-gray-300 rounded-lg shadow-sm text-sm w-full">
                             <option value="">Todos os Segmentos</option>
                         </select>
                     </div>
                     <div id="pd-postits-list" class="space-y-3 h-96 overflow-y-auto bg-gray-50 p-4 rounded-2xl shadow-sm border border-gray-200">
                         <p class="text-gray-500 placeholder-pd-postit">Nenhum post-it do P&D encontrado.</p>
                     </div>
                </section>
            </section>

            <!-- Segment Charts -->
            <section id="segment-charts-section" class="mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Tipos de Resposta por Segmento</h2>
                <div id="segment-charts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            </section>

            <!-- Team Tracking Section -->
             <section id="team-tracking-section" class="mb-10 bg-white p-6 rounded-2xl shadow-sm border">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-bold text-gray-900">Acompanhamento da Equipe (Sessão)</h2>
                     <input id="seller-search-input" type="text" placeholder="Procurar vendedor..." class="border-gray-300 rounded-lg shadow-sm text-sm">
                 </div>
                 <div id="sellers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 </div>
             </section>

        </div>
    </div>

    <!-- Modals -->
    <div id="segment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-2xl font-bold mb-4">Associar Vendedor a Segmento</h3>
            <p id="segment-modal-seller-name" class="text-gray-600 mb-6"></p>
            <div>
                 <select id="segment-select" class="w-full border-gray-300 rounded-lg"></select>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="confirm-segment-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <h3 class="text-2xl font-bold mb-4">Histórico de Notificações</h3>
            <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto border-t border-b py-4">
                 <p class="text-gray-500">Nenhum histórico para mostrar.</p>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="close-history-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

     <div id="chart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl h-4/5 p-6 relative">
             <button id="close-chart-modal-btn" class="absolute top-2 right-4 text-3xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
             <canvas id="modal-chart-canvas"></canvas>
         </div>
     </div>

     <div id="feedback-samples-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3 gap-2">
                 <h3 id="feedback-samples-title" class="text-xl font-bold">Amostras com Feedback:</h3>
                 <div class="flex items-center gap-2">
                     <label for="modal-segment-filter" class="text-sm font-medium">Segmento:</label>
                     <select id="modal-segment-filter" class="border-gray-300 rounded-lg shadow-sm text-sm p-1">
                         <option value="">Todos os Segmentos</option>
                     </select>
                 </div>
                 <button id="close-feedback-samples-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800 sm:ml-4">&times;</button>
             </div>
             <div id="feedback-samples-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                 <p class="text-gray-500">A carregar detalhes...</p>
             </div>
             <div class="mt-6 flex justify-end">
                 <button id="close-feedback-samples-btn-bottom" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
             </div>
         </div>
     </div>

     <div id="reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
             <h3 class="text-xl font-bold mb-4">Responder à Observação</h3>
             <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                 <p class="font-semibold" id="reply-modal-product"></p>
                 <p class="text-xs text-gray-600 mb-1" id="reply-modal-seller"></p>
                 <p class="italic">"${' '}"</p>
             </div>
             <div class="space-y-4">
                 <div>
                     <label for="manager-name-input" class="block text-sm font-medium text-gray-700">Seu Nome (Gestor)</label>
                     <input type="text" id="manager-name-input" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite seu nome">
                 </div>
                 <div>
                   <label for="reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta</label>
                   <textarea id="reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta aqui..."></textarea>
                 </div>
             </div>
             <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
             </div>
         </div>
     </div>

    <!-- Modais de Senhas -->
    <div id="senhas-gerentes-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Acessos dos Gerentes</h3>
                <button class="close-senhas-gerentes-btn text-3xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Segmento</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gerente</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Senha</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">CÁRNEOS</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">LUIS ADRIANO</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">carneospass123</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">LACTEOS</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">VITOR MACHADO</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">lacteospass456</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">NUTRICAO ANIMAL</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">DANILO TREMOLCOLDI</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">nutricaopass303</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">PANIFICACAO</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">MARISTELA</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">panificacaopass101</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">SMB</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">GUSTAVO BONFIM</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">smbpass202</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">SORVETES</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">VINICIUS MADALENO</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">sorvetespass789</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-end">
                <button class="close-senhas-gerentes-btn bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <div id="senhas-pd-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Acessos de P&D</h3>
                <button class="close-senhas-pd-btn text-3xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Área / Segmento</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Senha</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Panificação</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_adriana5</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Cárneos</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_anderson3</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Aromas Doces, Salgados e Molhos</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_carlos1</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Nutracêuticos</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_daise4</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Lácteos</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_flavia2</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Sorvetes</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_margarida7</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Nutrição Animal</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">pd_rebeca6</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-end">
                <button class="close-senhas-pd-btn bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro. Tente novamente.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, writeBatch, setDoc, getDoc, getDocs, 
            updateDoc, query, orderBy, serverTimestamp, addDoc, limit, where, runTransaction, 
            Timestamp, collectionGroup, getCountFromServer 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
             apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
             authDomain: "feedback-vendedores.firebaseapp.com",
             projectId: "feedback-vendedores",
             storageBucket: "feedback-vendedores.firebasestorage.app",
             messagingSenderId: "650880422749",
             appId: "1:650880422749:web:54a258964a6ca8db180eb4",
             measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        const SEGMENTS = ['CÁRNEOS', 'EXPORTACAO', 'FOOD SERVICE', 'LACTEOS', 'NUTRACEUTICOS', 'NUTRICAO ANIMAL', 'PANIFICACAO', 'SMB', 'SORVETES', 'SUPPLY/FIS'];
        const AROMA_FILTER_VALUE = 'AROMAS_FILTER';

        // --- DOM Elements ---
        const infoMessage = document.getElementById('info-message');
        const sessionIdText = document.getElementById('session-id-text');
        const dashboard = document.getElementById('dashboard');
        const connectionSection = document.getElementById('connection-section');
        const segmentModal = document.getElementById('segment-modal');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const confirmSegmentBtn = document.getElementById('confirm-segment-btn');
        const segmentSelect = document.getElementById('segment-select');
        const segmentModalSellerName = document.getElementById('segment-modal-seller-name');
        const sellersListContainer = document.getElementById('sellers-list');
        const notificationsList = document.getElementById('notifications-list');
        const segmentChartsGrid = document.getElementById('segment-charts-grid');
        const sellerSearchInput = document.getElementById('seller-search-input');
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const historyList = document.getElementById('history-list');
        const notificationsPermissionBtn = document.getElementById('notifications-permission-btn');
        const bellIcon = document.getElementById('bell-icon');
        const observationSegmentFilter = document.getElementById('observation-segment-filter');
        const observationSearchInput = document.getElementById('observation-search-input');
        const chartModal = document.getElementById('chart-modal');
        const closeChartModalBtn = document.getElementById('close-chart-modal-btn');
        const modalChartCanvas = document.getElementById('modal-chart-canvas');
        const feedbackSamplesModal = document.getElementById('feedback-samples-modal');
        const feedbackSamplesTitle = document.getElementById('feedback-samples-title');
        const feedbackSamplesList = document.getElementById('feedback-samples-list');
        const closeFeedbackSamplesBtn = document.getElementById('close-feedback-samples-btn');
        const closeFeedbackSamplesBtnBottom = document.getElementById('close-feedback-samples-btn-bottom');
        const modalSegmentFilter = document.getElementById('modal-segment-filter');
        const replyModal = document.getElementById('reply-modal');
        const replyModalProduct = document.getElementById('reply-modal-product');
        const replyModalSeller = document.getElementById('reply-modal-seller');
        const replyModalObservation = replyModal.querySelector('.italic');
        const managerNameInput = document.getElementById('manager-name-input');
        const replyMessageInput = document.getElementById('reply-message-input');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const sendReplyBtn = document.getElementById('send-reply-btn');
        
        const senhasGerentesModal = document.getElementById('senhas-gerentes-modal');
        const openSenhasGerentesBtn = document.getElementById('open-senhas-gerentes-btn');
        const closeSenhasGerentesBtns = document.querySelectorAll('.close-senhas-gerentes-btn');
        const senhasPdModal = document.getElementById('senhas-pd-modal');
        const openSenhasPdBtn = document.getElementById('open-senhas-pd-btn');
        const closeSenhasPdBtns = document.querySelectorAll('.close-senhas-pd-btn');

        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        const pdPostitsList = document.getElementById('pd-postits-list');
        const pdPostitSegmentFilter = document.getElementById('pd-postit-segment-filter');

        // --- State Variables ---
        // *** CORREÇÃO: Alterado 'samplesListenerUnsubscribe' para uma lista ***
        let samplesListenersUnsubscribe = []; // Lista de unsubscribers, um por vendedor
        let notificationListenerUnsubscribe = null;
        let sellerRepliesListenerUnsubscribe = null;
        let sellerRepliesToManagerListenerUnsubscribe = null;
        let destaquesAmostrasListenerUnsubscribe = null;
        let historicalAromaDataUnsubscribe = null;
        let pdPostitsListenerUnsubscribe = null;
        let currentSessionId = null;
        let chartInstances = {};
        let modalChartInstance = null;
        let currentSellerForSegment = null;
        let allCurrentSamples = [];
        let sellerSegmentsCache = {};
        let currentFeedbackFilter = '';
        let allSellerReplies = [];
        let allSellerRepliesToManager = [];
        let highlightedSamplesCache = [];
        let allPdPostits = [];
        let currentSampleForReply = null;
        let allNotifications = [];
        let areAllNotificationsVisible = false;
        let historicalAromaData = [];
        let sellerDataCache = {}; // Cache para { sellerId: { originalName, accessCode } }
        // *** NOVO: Cache para armazenar amostras por vendedor ***
        let samplesBySellerCache = {}; // { sellerId: [amostra1, amostra2] }


        // --- Utility Functions ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';
        const sanitizeForFirebaseId = (text) => normalizeText(text).replace(/\//g, "-");

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }

        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            if (error.code === 'resource-exhausted' || error.message.includes('Quota exceeded')) {
                showAlert(
                    "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã ou contate o suporte.", 
                    "Limite da Plataforma Atingido", 
                    "text-amber-600"
                );
            } else {
                showAlert(
                    `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`, 
                    "Erro na Operação",
                    "text-red-600"
                );
            }
        }

        function isAroma(produto, descricao) {
            const normalizedProduto = normalizeText(produto);
            const normalizedDescricao = normalizeText(descricao);
            if (normalizedProduto.startsWith('DAR ') || normalizedProduto.startsWith('AROMAS ')) {
                return true;
            }
            if (normalizedDescricao.includes('AROMA')) {
                return true;
            }
            return false;
        }

        function getCanonicalFeedback(feedback) {
             if (!feedback) return '';
             const normalized = normalizeText(feedback.replace(/^(A - |R - |E - |P - )/, '').trim());
             const mapping = {
                 'APROVADO COM PEDIDO': 'COM PEDIDO',
                 'APROVADA SEM PEDIDO': 'APROVADO SEM PEDIDO',
                 'INNOVATION / EVENTOS': 'EVENTO',
                 'AMOSTRA NAO TESTADA': 'AMOSTRA NÃO TESTADA',
                 'EM ANALISE': 'EM ANÁLISE'
             };
             return mapping[normalized] || normalized;
         }
         
        function getSellerNameFromPdContext(context = '') {
            if (!context || !context.includes('(')) return null;
            try {
                let name = context.split('(').pop(); 
                return normalizeText(name.replace(')', ''));
            } catch (e) {
                console.warn("Could not parse seller name from context:", context, e);
                return null;
            }
        }


        // --- Main Dashboard Rendering Function ---
        // *** CORREÇÃO: Não precisa mais de parâmetros, usa caches globais ***
        function processAndDisplayDashboard() {
            dashboard.classList.remove('hidden');
            connectionSection.classList.remove('hidden');
            sessionIdText.innerHTML = `Sessão Ativa: <strong>${currentSessionId}</strong>`;
            infoMessage.textContent = "Dados carregados. Ouvindo atualizações em tempo real.";

            // Combina amostras de todos os vendedores do cache
            allCurrentSamples = Object.values(samplesBySellerCache).flat();
            
            const combinedSamplesForStats = [...allCurrentSamples, ...historicalAromaData];

            renderCharts(combinedSamplesForStats);
            renderFeedbackDetails(combinedSamplesForStats);
            renderSegmentCharts(allCurrentSamples);
            renderSellersList(); // Usa caches globais (sellerDataCache, samplesBySellerCache)
            renderObservationsFeed(allCurrentSamples);
            renderPdPostits();

            populateSegmentFilters();
        }

        // --- Event Listeners ---
        // (Event listeners de modais, botões e filtros permanecem os mesmos)
        cancelModalBtn.addEventListener('click', () => segmentModal.classList.add('hidden'));
        historyBtn.addEventListener('click', () => renderNotificationHistory());
        closeHistoryBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
        notificationsPermissionBtn.addEventListener('click', () => {
            Notification.requestPermission().then(setupNotificationButton);
        });
        closeChartModalBtn.addEventListener('click', () => chartModal.classList.add('hidden'));
        closeFeedbackSamplesBtn.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        closeFeedbackSamplesBtnBottom.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        modalSegmentFilter.addEventListener('change', () => {
             showFeedbackSamples(currentFeedbackFilter, modalSegmentFilter.value);
        });
        cancelReplyBtn.addEventListener('click', () => replyModal.classList.add('hidden'));
        sendReplyBtn.addEventListener('click', sendReplyToSeller);
        
        if (openSenhasGerentesBtn) {
            openSenhasGerentesBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                senhasGerentesModal.classList.remove('hidden');
            });
        }
        closeSenhasGerentesBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                senhasGerentesModal.classList.add('hidden');
            });
        });

        if (openSenhasPdBtn) {
            openSenhasPdBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                e.stopPropagation(); 
                senhasPdModal.classList.remove('hidden');
            });
        }
        closeSenhasPdBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                senhasPdModal.classList.add('hidden');
            });
        });

        confirmSegmentBtn.addEventListener('click', async () => {
            if (!currentSellerForSegment || !currentSessionId) return;
            const newSegment = segmentSelect.value;
            const sellerId = sanitizeForFirebaseId(currentSellerForSegment);
            const docRef = doc(db, "vendedorConfig", sellerId);

            try {
                await setDoc(docRef, { segmento: newSegment }, { merge: true }); 
                sellerSegmentsCache[normalizeText(currentSellerForSegment)] = newSegment;
                
                infoMessage.textContent = `Segmento de ${currentSellerForSegment} atualizado.`;
                segmentModal.classList.add('hidden');
                
                processAndDisplayDashboard();

                 setTimeout(() => infoMessage.textContent = 'Dados carregados. Ouvindo atualizações.', 3000);
            } catch (error) {
                handleFirestoreError(error, `atualizar segmento de ${currentSellerForSegment}`);
            }
        });

        sellerSearchInput.addEventListener('input', () => {
            const searchTerm = normalizeText(sellerSearchInput.value);
            const sellerCards = sellersListContainer.querySelectorAll('.seller-card');
            sellerCards.forEach(card => {
                const sellerName = normalizeText(card.dataset.sellerName);
                card.style.display = sellerName.includes(searchTerm) ? '' : 'none';
            });
        });

        observationSegmentFilter.addEventListener('change', () => renderObservationsFeed(allCurrentSamples));
        observationSearchInput.addEventListener('input', () => renderObservationsFeed(allCurrentSamples));
        
        if (pdPostitSegmentFilter) {
            pdPostitSegmentFilter.addEventListener('change', () => renderPdPostits());
        }

        // --- Core Functions ---

        function resetToInitialState() {
            // *** CORREÇÃO: Limpa a lista de listeners de amostras ***
            samplesListenersUnsubscribe.forEach(unsub => unsub());
            samplesListenersUnsubscribe = [];
            
            if (notificationListenerUnsubscribe) notificationListenerUnsubscribe();
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            if (sellerRepliesToManagerListenerUnsubscribe) sellerRepliesToManagerListenerUnsubscribe();
            if (destaquesAmostrasListenerUnsubscribe) destaquesAmostrasListenerUnsubscribe();
            if (historicalAromaDataUnsubscribe) historicalAromaDataUnsubscribe();
            if (pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();

            currentSessionId = null;
            allCurrentSamples = [];
            allNotifications = [];
            allSellerReplies = [];
            allSellerRepliesToManager = [];
            highlightedSamplesCache = [];
            allPdPostits = [];
            areAllNotificationsVisible = false;
            sellerSegmentsCache = {};
            currentSampleForReply = null;
            currentFeedbackFilter = '';
            historicalAromaData = [];
            sellerDataCache = {};
            samplesBySellerCache = {}; // Limpa cache de amostras

            dashboard.classList.add('hidden');
            sessionIdText.textContent = 'A conectar...';
            infoMessage.textContent = 'A procurar sessão ativa...';
            connectionSection.classList.remove('hidden');

            updateNotificationDisplay();
            renderPdPostits();
        }

        function listenForActiveSession() {
            const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
            let unsubscribe = null;

            unsubscribe = onSnapshot(activeSessionRef, async (docSnap) => {
                const activeSessionId = docSnap.exists() ? docSnap.data().current : null;

                if (activeSessionId) {
                    if (activeSessionId !== currentSessionId) {
                        console.log(`Nova sessão ativa encontrada: ${activeSessionId}. A conectar...`);
                        resetToInitialState();
                        currentSessionId = activeSessionId;
                        infoMessage.textContent = `Sessão ativa: ${activeSessionId}. A carregar dados...`;
                        
                        await loadAllSellerData();
                        await loadAllSellerSegments();
                        // *** CORREÇÃO: Inicia o listener de amostras (que agora itera) ***
                        listenForSamples();
                        
                        listenForNotifications();
                        listenForSellerReplies();
                        listenForSellerRepliesToManager();
                        listenForDestaquesAmostras();
                        listenForHistoricalAromaData();
                        listenForPdPostits();
                    }
                } else {
                    console.warn("Nenhuma sessão ativa encontrada.");
                    resetToInitialState();
                    infoMessage.textContent = 'Nenhuma sessão ativa encontrada.';
                }
            }, (error) => {
                infoMessage.textContent = "Erro ao verificar sessão ativa.";
                console.error("Active session listener error:", error);
                resetToInitialState();
            });
        }
        
        async function loadAllSellerData() {
            if (!currentSessionId) return;
            
            const sellersRef = collection(db, "sessoes", currentSessionId, "vendedores");
            try {
                const snapshot = await getDocs(sellersRef);
                sellerDataCache = {};
                snapshot.forEach(doc => {
                    sellerDataCache[doc.id] = doc.data();
                });
                console.log(`Cache de dados de ${Object.keys(sellerDataCache).length} vendedores carregado.`);
            } catch (error) {
                handleFirestoreError(error, "carregar dados dos vendedores");
            }
        }

        // *** CORREÇÃO: Nova lógica para ouvir amostras sem collectionGroup ***
        function listenForSamples() {
            // Limpa listeners antigos
            samplesListenersUnsubscribe.forEach(unsub => unsub());
            samplesListenersUnsubscribe = [];
            samplesBySellerCache = {}; // Limpa cache de amostras
            allCurrentSamples = [];

            if (Object.keys(sellerDataCache).length === 0) {
                console.warn("Nenhum vendedor encontrado no cache. Não é possível ouvir amostras.");
                processAndDisplayDashboard(); // Renderiza o painel (vazio)
                return;
            }
            
            let sellersProcessed = 0;
            const totalSellers = Object.keys(sellerDataCache).length;

            // Para cada vendedor no cache, cria um listener para suas amostras
            Object.keys(sellerDataCache).forEach(sellerId => {
                const samplesQuery = query(
                    collection(db, "sessoes", currentSessionId, "vendedores", sellerId, "amostras")
                );

                const unsubscribe = onSnapshot(samplesQuery, (snapshot) => {
                    const previousSamples = [...allCurrentSamples];
                    
                    // Atualiza o cache de amostras para este vendedor
                    samplesBySellerCache[sellerId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Reconstrói a lista 'allCurrentSamples' a partir do cache
                    allCurrentSamples = Object.values(samplesBySellerCache).flat();
                    
                    // Se não for a carga inicial, processa notificações
                    if (sellersProcessed >= totalSellers) { // Só processa updates após todos carregarem 1x
                         processSampleUpdates(allCurrentSamples, previousSamples);
                    }
                    
                    // Re-renderiza o dashboard completo
                    processAndDisplayDashboard();

                }, (error) => {
                    handleFirestoreError(error, `ouvir amostras do vendedor ${sellerId}`);
                });

                samplesListenersUnsubscribe.push(unsubscribe); // Adiciona à lista para limpeza
                
                // Marca como processado APÓS o primeiro callback (idealmente)
                // Mas para UI, marcamos aqui
                sellersProcessed++;
            });
        }


        // Função 'processSampleUpdates' (permanece a mesma)
        async function processSampleUpdates(currentSamples, previousSamples) {
             const batch = writeBatch(db);
             let notificationAdded = false;

             const newFeedbacks = currentSamples.filter(currentSample => {
                 const prevSample = previousSamples.find(p => p.id === currentSample.id);
                 return prevSample && (prevSample.isPending === true) && (currentSample.isPending === false);
             });

             if (newFeedbacks.length > 0) {
                 newFeedbacks.forEach(sample => {
                     const message = `<strong>${sample.sellerName}</strong> deu feedback para <strong>${sample.produto}</strong>: ${sample.feedback} (Ped: ${sample.pedido})`;
                     const notifId = sanitizeForFirebaseId(`notif-${sample.id}-${Date.now()}`);
                     const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);
                     batch.set(notifRef, {
                         message,
                         color: 'blue',
                         timestamp: serverTimestamp(),
                         triggerPopup: false
                     });
                     notificationAdded = true;
                 });
             }

             const editedSamples = currentSamples.filter(currentSample => {
                 const prevSample = previousSamples.find(p => p.id === currentSample.id);
                 return prevSample && 
                        (prevSample.editedAfterCompletion !== true) && 
                        (currentSample.editedAfterCompletion === true);
             });

             if (editedSamples.length > 0) {
                  editedSamples.forEach(sample => {
                     const message = `<strong>${sample.sellerName}</strong> <i>editou</i> o feedback para <strong>${sample.produto}</strong> (Ped: ${sample.pedido}): ${sample.feedback}`;
                     const notifId = sanitizeForFirebaseId(`edit-notif-${sample.id}-${Date.now()}`);
                     const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);
                     batch.set(notifRef, {
                         message,
                         color: 'orange',
                         timestamp: serverTimestamp(),
                         triggerPopup: true
                     });
                     notificationAdded = true;
                  });
             }

             if (notificationAdded) {
                 try {
                     await batch.commit();
                 } catch (commitError) {
                     handleFirestoreError(commitError, "guardar notificações de feedback");
                 }
             }
        }


        // (Todas as outras funções 'listenFor...' permanecem as mesmas da v2)
        function listenForNotifications() {
            if (notificationListenerUnsubscribe) notificationListenerUnsubscribe();
            const q = query(collection(db, "sessoes", currentSessionId, "notificacoes"), orderBy("timestamp", "desc"));

            let initialLoad = true;
            notificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allNotifications = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp
                }));
                updateNotificationDisplay();

                if (!initialLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added" && !change.doc.metadata.fromCache) {
                            const notificationData = change.doc.data();
                            if (notificationData.triggerPopup === true) {
                                const cleanMessage = notificationData.message.replace(/<[^>]*>?/gm, '');
                                showBrowserNotification(notificationData.color === 'green' ? 'Tarefa Finalizada' : 'Nova Resposta', cleanMessage);
                            }
                        }
                    });
                }
                initialLoad = false;
            }, (error) => {
                 handleFirestoreError(error, "ouvir notificações do gestor");
            });
        }

        async function listenForSellerReplies() {
            if (!currentSessionId) return;
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();

            const repliesRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
            const q = query(repliesRef);

            sellerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allSellerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 console.log(`[v2] Loaded/Updated ${allSellerReplies.length} manager replies.`);
                 if(!dashboard.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                     if (!feedbackSamplesModal.classList.contains('hidden') && currentFeedbackFilter) {
                         showFeedbackSamples(currentFeedbackFilter, modalSegmentFilter.value);
                     }
                 }
            }, (error) => {
                 handleFirestoreError(error, "ouvir respostas para vendedores");
                 allSellerReplies = [];
            });
        }

        async function listenForSellerRepliesToManager() {
            if (!currentSessionId) return;
            if (sellerRepliesToManagerListenerUnsubscribe) sellerRepliesToManagerListenerUnsubscribe();

            const repliesRef = collection(db, "sessoes", currentSessionId, "respostasVendedor");
            const q = query(repliesRef, where("readByManager", "==", false));

            sellerRepliesToManagerListenerUnsubscribe = onSnapshot(q, async (snapshot) => {
                for (const change of snapshot.docChanges()) {
                    if (change.type === "added") {
                        const replyData = change.doc.data();
                        const replyDocRef = change.doc.ref;

                        try {
                            await runTransaction(db, async (transaction) => {
                                const replyDocSnap = await transaction.get(replyDocRef);
                                if (!replyDocSnap.exists() || replyDocSnap.data().readByManager === true) {
                                    return; 
                                }

                                const isPDReply = replyData.originalManagerName === "P&D";
                                const senderName = isPDReply ? `${replyData.sellerName} (P&D)` : replyData.sellerName;
                                const message = `<strong>${senderName}</strong> respondeu à sua observação sobre <strong>${replyData.produto}</strong>: "${replyData.replyMessage}"`;
                                
                                const notifId = sanitizeForFirebaseId(`seller-reply-${replyDocRef.id}`);
                                const notifRef = doc(db, "sessoes", currentSessionId, "notificacoes", notifId);

                                transaction.set(notifRef, {
                                    message,
                                    color: isPDReply ? 'purple' : 'orange',
                                    timestamp: serverTimestamp(),
                                    triggerPopup: true
                                });
                                transaction.update(replyDocRef, { readByManager: true });
                            });
                        } catch (error) {
                            handleFirestoreError(error, `processar a resposta ${replyDocRef.id}`);
                        }
                    }
                }

                if(!dashboard.classList.contains('hidden')) {
                     const fullQuery = query(collection(db, "sessoes", currentSessionId, "respostasVendedor"));
                     const fullSnapshot = await getDocs(fullQuery);
                     allSellerRepliesToManager = fullSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     renderObservationsFeed(allCurrentSamples);
                     if (!feedbackSamplesModal.classList.contains('hidden') && currentFeedbackFilter) {
                         showFeedbackSamples(currentFeedbackFilter, modalSegmentFilter.value);
                     }
                }
            }, (error) => {
                 handleFirestoreError(error, "ouvir respostas de vendedores");
                 allSellerRepliesToManager = [];
            });
        }

        function listenForDestaquesAmostras() {
            if (!currentSessionId) return;
            if (destaquesAmostrasListenerUnsubscribe) destaquesAmostrasListenerUnsubscribe();
            
            const destaquesRef = doc(db, "sessoes", currentSessionId, "configuracoes", "destaquesAmostras");

            destaquesAmostrasListenerUnsubscribe = onSnapshot(destaquesRef, (docSnap) => {
                highlightedSamplesCache = docSnap.exists() ? (docSnap.data().lista || []) : [];
                if (!feedbackSamplesModal.classList.contains('hidden') && currentFeedbackFilter) {
                    showFeedbackSamples(currentFeedbackFilter, modalSegmentFilter.value);
                }
            }, (error) => {
                handleFirestoreError(error, "ouvir destaques de amostras");
                highlightedSamplesCache = [];
            });
        }

        function listenForHistoricalAromaData() {
            if (!currentSessionId) return;
            if (historicalAromaDataUnsubscribe) historicalAromaDataUnsubscribe();

            const historicalDocRef = doc(db, "sessoes", currentSessionId, "configuracoes", "dadosHistoricosAroma");

            historicalAromaDataUnsubscribe = onSnapshot(historicalDocRef, (docSnap) => {
                const newData = docSnap.exists() ? (docSnap.data().data || []) : [];
                
                if (JSON.stringify(historicalAromaData) !== JSON.stringify(newData)) {
                     console.log(`Dados históricos de aroma atualizados. Registros: ${newData.length}`);
                     historicalAromaData = newData;
                     
                     if (!dashboard.classList.contains('hidden') && currentSessionId) {
                         processAndDisplayDashboard(); 
                     }
                }
            }, (error) => {
                handleFirestoreError(error, "ouvir dados históricos de aroma");
                historicalAromaData = [];
            });
        }
        
        function listenForPdPostits() {
            if (!currentSessionId) return;
            if (pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();

            const q = query(
                collection(db, "sessoes", currentSessionId, "pdPostits"),
                orderBy("timestamp", "desc")
            );

            pdPostitsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allPdPostits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!dashboard.classList.contains('hidden')) {
                    renderPdPostits();
                }
            }, (error) => {
                handleFirestoreError(error, "carregar post-its P&D");
                allPdPostits = [];
            });
        }


        async function toggleDestaqueAmostra(e) {
            e.stopPropagation();
            const sampleId = e.currentTarget.dataset.sampleId;
            if (!currentSessionId || !sampleId) return;

            const destaquesRef = doc(db, "sessoes", currentSessionId, "configuracoes", "destaquesAmostras");
            const button = e.currentTarget;
            button.disabled = true;

            try {
                await runTransaction(db, async (transaction) => {
                    const destaquesDoc = await transaction.get(destaquesRef);
                    const currentList = destaquesDoc.exists() ? (destaquesDoc.data().lista || []) : [];
                    let updatedList = [...currentList];

                    if (updatedList.includes(sampleId)) {
                        updatedList = updatedList.filter(id => id !== sampleId);
                    } else {
                        updatedList.push(sampleId);
                    }
                    transaction.set(destaquesRef, { lista: updatedList });
                });
            } catch (error) {
                handleFirestoreError(error, "atualizar destaques de amostra");
            } finally {
                button.disabled = false;
            }
        }


        // --- UI Rendering Functions ---

        // (Todas as funções 'render...' permanecem as mesmas da v2)
        // ...
        // Renderiza gráficos principais
        function renderCharts(samples) {
            let pending = 0, resolved = 0, approved = 0, rejected = 0, events = 0;
            const feedbackCounts = {};

            const APPROVED_WITHOUT_PREFIX = ['COM PEDIDO', 'APROVADO SEM PEDIDO'];
            const REJECTED_WITHOUT_PREFIX = ['APRESENTAÇÃO PRÓ ATIVA', 'CALIBRE', 'EXTRAVIADA', 'FORA DA ESPECIFICAÇÃO DO CLIENTE', 'FORA DO PERFIL DO CLIENTE', 'FRACA / ESTOURANDO / COM CHUVEIRO', 'PRODUTO DESCONTINUADO', 'QUANTIDADE INSUFICIENTE', 'REPRESENTAÇÃO / DISTRIBUIDOR', 'SEM RETORNO DO CLIENTE', 'EXPORTACAO'];
            const EVENTS_WITHOUT_PREFIX = ['INNOVATION / EVENTOS', 'EVENTO'];

            samples.forEach(s => {
                let isSamplePending = s.isPending;
                if (typeof isSamplePending === 'undefined') {
                    isSamplePending = PENDING_STATUSES.includes(normalizeText(s.originalStatus));
                }

                if (isSamplePending) {
                    pending++;
                } else {
                    resolved++;
                    if (s.feedback && s.feedback.trim() !== '') {
                        const feedbackKey = s.feedback.trim();
                        const normalizedFeedback = getCanonicalFeedback(feedbackKey);
                        feedbackCounts[normalizedFeedback] = (feedbackCounts[normalizedFeedback] || 0) + 1;

                        if (feedbackKey.startsWith('A -') || APPROVED_WITHOUT_PREFIX.includes(normalizedFeedback)) {
                            approved++;
                        } else if (feedbackKey.startsWith('R -') || REJECTED_WITHOUT_PREFIX.includes(normalizedFeedback)) {
                            rejected++;
                        } else if (feedbackKey.startsWith('E -') || EVENTS_WITHOUT_PREFIX.includes(normalizedFeedback)) {
                            events++;
                        }
                    }
                }
            });

            renderChart('session-status-chart', 'doughnut', {
                labels: ['Pendentes', 'Resolvidos'],
                datasets: [{ data: [pending, resolved], backgroundColor: ['#facc15', '#3b82f6'] }]
            });

            const rejectionChartTitle = document.getElementById('rejection-chart-title');
            rejectionChartTitle.textContent = 'Distribuição de Feedbacks';
            if (approved === 0 && rejected === 0 && events === 0 && resolved > 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Detalhes'], datasets: [{ data: [resolved], backgroundColor: ['#e5e7eb'] }] });
            } else if (approved === 0 && rejected === 0 && events === 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Respostas'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] });
            }
             else {
                renderChart('rejection-rate-chart', 'doughnut', {
                    labels: ['Aprovadas', 'Reprovadas', 'Eventos'],
                    datasets: [{
                        data: [approved, rejected, events],
                        backgroundColor: ['#34d399', '#f87171', '#a78bfa']
                    }]
                });
            }
        }

        function renderChart(canvasId, type, data, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            Chart.register(ChartDataLabels);

            const finalOptions = {
                responsive: true,
                maintainAspectRatio: false,
                ...options,
                plugins: {
                    legend: { display: type === 'doughnut' },
                    datalabels: { display: false },
                    ...options.plugins
                }
            };

            chartInstances[canvasId] = new Chart(ctx, { type, data, options: finalOptions });
            canvas.onclick = () => openChartModal(canvasId);
        }

        function openChartModal(canvasId) {
            const originalChart = chartInstances[canvasId];
            if (!originalChart) return;

            if (modalChartInstance) {
                modalChartInstance.destroy();
            }

            const modalCtx = modalChartCanvas.getContext('2d');
            const modalOptions = JSON.parse(JSON.stringify(originalChart.config.options));
            if (originalChart.config.type === 'bar' || (originalChart.config.type === 'doughnut' && canvasId !== 'session-status-chart')) {
                 modalOptions.plugins.datalabels = {
                     display: true,
                     color: 'white',
                     font: { weight: 'bold' },
                     formatter: (value, context) => {
                         if (originalChart.config.type === 'doughnut') {
                             const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                             const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0%';
                             return `${value}\n(${percentage})`;
                         }
                         return value;
                     }
                 };
            }
            modalOptions.maintainAspectRatio = false;

            modalChartInstance = new Chart(modalCtx, {
                type: originalChart.config.type,
                data: originalChart.config.data,
                options: modalOptions
            });

            chartModal.classList.remove('hidden');
        }

        // Renderiza lista de vendedores (agora usa caches)
        function renderSellersList() {
            sellersListContainer.innerHTML = '';
            
            // Itera sobre o cache de dados dos vendedores (carregado no início)
            Object.keys(sellerDataCache).sort((a,b) => sellerDataCache[a].originalName.localeCompare(sellerDataCache[b].originalName)).forEach(sellerId => {
                const sellerData = sellerDataCache[sellerId];
                const sellerName = sellerData.originalName;
                
                // Pega as amostras deste vendedor do cache de amostras
                const sellerSamples = samplesBySellerCache[sellerId] || [];
                
                const totalPending = sellerSamples.filter(s => s.isPending).length;
                const isFinalizedByVendor = totalPending === 0;
                
                // Verifica o status 'baixado'
                let systemStatus = 'pending';
                if (sellerSamples.length > 0 && sellerSamples.every(s => s.systemStatus === 'baixado')) {
                    systemStatus = 'baixado';
                }

                let statusColor = 'yellow';
                if (isFinalizedByVendor && systemStatus === 'pending') {
                    statusColor = 'green';
                } else if (systemStatus === 'baixado') {
                    statusColor = 'purple';
                }

                const card = document.createElement('div');
                card.className = `p-4 rounded-lg shadow bg-white border-l-4 border-${statusColor}-500 seller-card`;
                card.dataset.sellerName = sellerName;

                const segment = sellerSegmentsCache[normalizeText(sellerName)] || 'Sem Segmento';

                let statusHTML = `<span class="text-xs text-gray-500">${isFinalizedByVendor ? 'Finalizado' : `${totalPending} pendente(s)`}</span>`;
                if (isFinalizedByVendor && systemStatus === 'pending') {
                    statusHTML = `
                         <div class="flex items-center space-x-2">
                             <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                 <input type="checkbox" class="system-check-btn rounded" data-seller-name="${sellerName}">
                                 <span>Dar Baixa</span>
                             </label>
                         </div>`;
                } else if (systemStatus === 'baixado') {
                    statusHTML = `<span class="text-sm font-semibold text-purple-600">✓ Baixado em Sistema</span>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-lg flex items-center">
                           ${sellerName}
                        </div>
                        <button class="config-seller-btn text-gray-400 hover:text-gray-600" data-seller-name="${sellerName}" title="Definir Segmento">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a1 1 0 00-2 0v2.28a1 1 0 00.9 1.42A7.48 7.48 0 0110 8a7.48 7.48 0 015.1 2.7.999.999 0 00.9-1.42V4a1 1 0 10-2 0v1.588A5.502 5.502 0 0010 5.03 5.502 5.502 0 005 5.588V4zM10 12a2 2 0 100 4 2 2 0 000-4z"></path></svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 font-semibold">${segment}</p>
                    <div class="mt-4 flex items-center justify-between">
                         <div>${statusHTML}</div>
                         <div class="flex items-center space-x-2">
                             <span class="text-sm font-semibold text-gray-700">${sellerData.accessCode}</span>
                             <button class="copy-code-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-2 rounded" data-code="${sellerData.accessCode}">Copiar</button>
                         </div>
                    </div>`;
                sellersListContainer.appendChild(card);
            });

            // Add event listeners (a lógica interna permanece a mesma)
            document.querySelectorAll('.copy-code-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const textToCopy = e.currentTarget.dataset.code;
                    if (!textToCopy) return;
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                         const button = e.currentTarget;
                         button.textContent = 'Copiado!';
                         setTimeout(() => { button.textContent = 'Copiar'; }, 2000);
                    } catch (err) { console.error('Falha ao copiar código:', err); }
                    document.body.removeChild(textarea);
                };
            });

            document.querySelectorAll('.system-check-btn').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const checkboxEl = e.target;
                    if (checkboxEl.checked) {
                        checkboxEl.disabled = true;
                        
                        const sellerName = checkboxEl.dataset.sellerName;
                        const label = checkboxEl.closest('label');
                        const card = checkboxEl.closest('.seller-card');
                        
                        let labelSpan = null;
                        let originalLabelText = 'Dar Baixa';
                        if (label) {
                            labelSpan = label.querySelector('span');
                            if (labelSpan) {
                                originalLabelText = labelSpan.textContent;
                                labelSpan.textContent = 'A guardar...';
                                labelSpan.classList.add('label-saving');
                            }
                        }
                        if (card) {
                            card.classList.remove('border-green-500');
                            card.classList.add('border-purple-500');
                        }

                        try {
                            const sellerId = sanitizeForFirebaseId(sellerName);
                            const samplesToUpdateQuery = query(
                                collection(db, "sessoes", currentSessionId, "vendedores", sellerId, "amostras")
                            );
                            const samplesSnapshot = await getDocs(samplesToUpdateQuery);
                            
                            const batch = writeBatch(db);
                            samplesSnapshot.forEach(doc => {
                                batch.update(doc.ref, { systemStatus: 'baixado' });
                            });
                            await batch.commit();
                            
                            console.log(`Status do sistema atualizado para 'baixado' para ${sellerName}.`);

                        } catch (error) {
                            handleFirestoreError(error, `dar baixa para ${sellerName}`);
                            
                            checkboxEl.checked = false;
                            checkboxEl.disabled = false;
                            if (labelSpan) {
                                labelSpan.textContent = originalLabelText;
                                labelSpan.classList.remove('label-saving');
                            }
                            if (card) {
                                card.classList.remove('border-purple-500');
                                card.classList.add('border-green-500');
                            }
                        }
                    }
                });
            });

             document.querySelectorAll('.config-seller-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     openSegmentModal(e.currentTarget.dataset.sellerName);
                 });
             });
        }

        // 'renderObservationsFeed' permanece a mesma
        function renderObservationsFeed(samples) {
            const feedContainer = document.getElementById('observations-feed-list');
            const segmentFilter = observationSegmentFilter.value;
            const searchTerm = normalizeText(observationSearchInput.value);

            let filteredSamples = samples.filter(s => s.observation && s.observation.trim() !== '');

            if (segmentFilter) {
                if (segmentFilter === AROMA_FILTER_VALUE) {
                    filteredSamples = filteredSamples.filter(sample => isAroma(sample.produto, sample.descricao));
                } else {
                    filteredSamples = filteredSamples.filter(sample => sellerSegmentsCache[normalizeText(sample.sellerName)] === segmentFilter);
                }
            }
            if (searchTerm) {
                filteredSamples = filteredSamples.filter(sample =>
                    normalizeText(sample.sellerName).includes(searchTerm)
                );
            }

            filteredSamples.sort((a, b) => {
                const timeA = a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0;
                const timeB = b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0;
                return timeB - timeA;
            });

            if (filteredSamples.length === 0) {
                feedContainer.innerHTML = '<p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada com os filtros atuais.</p>';
                return;
            }

            feedContainer.innerHTML = '';
            filteredSamples.forEach(sample => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded-lg border bg-gray-50';

                const managerReply = allSellerReplies
                    .filter(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation)
                    .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];

                 let repliesHtml = '';
                 if (managerReply) {
                     const managerTime = managerReply.timestamp?.toDate() ? managerReply.timestamp.toDate().toLocaleString('pt-BR') : '';
                     repliesHtml += `
                         <div class="manager-reply">
                             <p><strong>${managerReply.managerName} respondeu:</strong> ${managerReply.replyMessage}</p>
                             <p class="text-xs text-gray-400 text-right">${managerTime}</p>
                         </div>
                     `;

                     const sellerOrPdReply = allSellerRepliesToManager
                         .filter(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido && r.produto === sample.produto)
                         .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];

                     if (sellerOrPdReply) {
                         const time = sellerOrPdReply.timestamp?.toDate() ? sellerOrPdReply.timestamp.toDate().toLocaleString('pt-BR') : '';
                         const isPDReply = sellerOrPdReply.originalManagerName === "P&D";
                         const senderName = isPDReply ? `${sellerOrPdReply.sellerName} (P&D)` : sellerOrPdReply.sellerName;
                         
                         repliesHtml += `
                             <div class="seller-reply">
                                 <p><strong>${senderName} respondeu:</strong> ${sellerOrPdReply.replyMessage}</p>
                                 <p class="text-xs text-gray-400 text-right">${time}</p>
                             </div>
                         `;
                     }
                 }

                const observationTime = sample.lastUpdate?.toDate() ? sample.lastUpdate.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                card.innerHTML = `
                    <div class="mb-2">
                        <p class="font-bold text-gray-800">${sample.produto} - ${sample.descricao || ''}</p>
                    </div>
                    <p class="text-gray-700 mb-3">"${sample.observation}"</p>
                    ${repliesHtml}
                    <div class="flex justify-between items-end text-xs text-gray-500 ${repliesHtml ? 'mt-2' : 'mt-3'}">
                         <div>
                             <p>- ${sample.sellerName} (Pedido: ${sample.pedido})</p>
                             <p class="text-gray-400">${observationTime}</p>
                         </div>
                        <button class="reply-observation-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                            ${managerReply ? 'Responder Novamente' : 'Responder'}
                        </button>
                    </div>
                `;
                feedContainer.appendChild(card);
            });

              feedContainer.querySelectorAll('.reply-observation-btn').forEach(btn => {
                  btn.addEventListener('click', openReplyModal);
              });
        }
        
        // 'openReplyModal' permanece a mesma
        function openReplyModal(event) {
             const sampleId = event.target.dataset.sampleId;
             const sample = allCurrentSamples.find(s => s.id === sampleId);
             if (!sample || !sample.observation) {
                 showAlert("Não é possível responder a uma amostra sem observação.");
                 return;
             }
             currentSampleForReply = sample;

             replyModalProduct.textContent = `${sample.produto} (${sample.pedido})`;
             replyModalSeller.textContent = `Observação de: ${sample.sellerName}`;
             replyModalObservation.textContent = `"${sample.observation}"`;
             replyMessageInput.value = '';
             managerNameInput.value = localStorage.getItem('managerName') || '';

             replyModal.classList.remove('hidden');
        }
        
        // 'renderPdPostits' permanece a mesma
        function renderPdPostits() {
            const feedContainer = document.getElementById('pd-postits-list');
            if (!feedContainer) return;
            
            const segmentFilter = pdPostitSegmentFilter ? pdPostitSegmentFilter.value : '';

            let filteredNotes = allPdPostits;
            if (segmentFilter) {
                if (segmentFilter === AROMA_FILTER_VALUE) {
                    filteredNotes = allPdPostits.filter(note => {
                        const contextProduct = note.context ? note.context.split('(')[0].trim() : '';
                        return isAroma(contextProduct, '');
                    });
                } else {
                    filteredNotes = allPdPostits.filter(note => {
                        const sellerName = getSellerNameFromPdContext(note.context);
                        if (!sellerName) return false;
                        return sellerSegmentsCache[sellerName] === segmentFilter;
                    });
                }
            }
            
            if (filteredNotes.length === 0) {
                feedContainer.innerHTML = '<p class="text-gray-500 placeholder-pd-postit">Nenhum post-it encontrado com os filtros atuais.</p>';
                return;
            }

            feedContainer.innerHTML = ''; 
            filteredNotes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'pd-postit-card';

                const time = note.timestamp?.toDate() ? note.timestamp.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                
                card.innerHTML = `
                    <p class="text-sm text-gray-800">${note.message}</p>
                    <div class="mt-2 pt-2 border-t border-amber-200">
                        <p class="text-xs text-gray-600 font-semibold">Pedido: <span class="font-normal">${note.pedido || 'N/A'}</span></p>
                        <p class="text-xs text-gray-600 font-semibold">Fat.: <span class="font-normal">${note.dataFaturamento || 'N/A'}</span></p>
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs">
                        <div>
                            <p class="font-semibold text-purple-700">${note.pdManagerName || 'P&D'}</p>
                            <p class="text-gray-500">${note.context || ''}</p>
                        </div>
                        <span class="text-gray-400">${time}</span>
                    </div>
                `;
                feedContainer.appendChild(card);
            });
        }

        // 'sendReplyToSeller' permanece a mesma
       async function sendReplyToSeller() {
           if (!currentSampleForReply || !currentSessionId) return;

           const managerName = managerNameInput.value.trim();
           const replyMessage = replyMessageInput.value.trim();

           if (!managerName || !replyMessage) {
               showAlert("Por favor, preencha o seu nome e a mensagem de resposta.");
               return;
           }

           sendReplyBtn.disabled = true;
           sendReplyBtn.textContent = 'A Enviar...';

           try {
               localStorage.setItem('managerName', managerName);

               const notificationData = {
                   managerName: managerName,
                   replyMessage: replyMessage,
                   originalObservation: currentSampleForReply.observation,
                   sellerName: currentSampleForReply.sellerName,
                   pedido: currentSampleForReply.pedido,
                   produto: currentSampleForReply.produto,
                   descricao: currentSampleForReply.descricao || '',
                   razaoSocial: currentSampleForReply.razaoSocial || '',
                   timestamp: serverTimestamp(),
                   read: false,
                   readByPd: false
               };

               const sellerNotifsRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
               await addDoc(sellerNotifsRef, notificationData);

               replyModal.classList.add('hidden');
               showAlert(`Resposta enviada para ${currentSampleForReply.sellerName}.`, "Sucesso", "text-green-600");

           } catch (error) {
               handleFirestoreError(error, "enviar resposta ao vendedor");
           } finally {
               sendReplyBtn.disabled = false;
               sendReplyBtn.textContent = 'Enviar Resposta';
               currentSampleForReply = null;
           }
       }

        // 'updateNotificationDisplay' permanece a mesma
        function updateNotificationDisplay() {
            notificationsList.innerHTML = '';

            if (allNotifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-gray-500 placeholder-notification">Nenhuma notificação nova.</p>';
                return;
            }

            allNotifications.sort((a, b) => {
                 const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
                 const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
                return timeB - timeA;
            });

            const notificationsToDisplay = areAllNotificationsVisible ? allNotifications : allNotifications.slice(0, 3);

            notificationsToDisplay.forEach(notification => {
                const card = document.createElement('div');
                const color = notification.color || 'blue';
                card.className = `notification-card bg-white p-3 rounded-lg shadow-sm border-l-4 border-${color}-500 flex justify-between items-center`;
                card.innerHTML = `<p class="text-sm">${notification.message}</p>`;
                notificationsList.appendChild(card);
            });

            if (allNotifications.length > 3 && !areAllNotificationsVisible) {
                const showMoreCard = document.createElement('div');
                showMoreCard.className = 'notification-card bg-gray-100 p-3 rounded-lg text-center cursor-pointer hover:bg-gray-200';
                showMoreCard.innerHTML = `<p class="text-sm font-semibold text-gray-700">+${allNotifications.length - 3} mais</p>`;
                showMoreCard.onclick = () => {
                    areAllNotificationsVisible = true;
                    updateNotificationDisplay();
                };
                notificationsList.appendChild(showMoreCard);
            } else if (areAllNotificationsVisible && allNotifications.length > 3) {
                 const showLessCard = document.createElement('div');
                 showLessCard.className = 'notification-card bg-gray-100 p-3 rounded-lg text-center cursor-pointer hover:bg-gray-200';
                 showLessCard.innerHTML = `<p class="text-sm font-semibold text-gray-700">Mostrar menos</p>`;
                 showLessCard.onclick = () => {
                     areAllNotificationsVisible = false;
                     updateNotificationDisplay();
                 };
                 notificationsList.appendChild(showLessCard);
            }
        }

        // 'renderNotificationHistory' permanece a mesma
        function renderNotificationHistory() {
            historyList.innerHTML = '';
            const sortedNotifications = [...allNotifications].sort((a, b) => {
                 const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
                 const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
                 return timeB - timeA;
            });

            if (sortedNotifications.length === 0) {
                historyList.innerHTML = `<p class="text-gray-500">Nenhum histórico para mostrar.</p>`;
            } else {
                sortedNotifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border-b';
                    const timestampDate = notification.timestamp?.toDate ? notification.timestamp.toDate() : null;
                    item.innerHTML = `
                         <p class="text-sm text-gray-800">${notification.message}</p>
                         <p class="text-xs text-gray-500 mt-1">${timestampDate ? timestampDate.toLocaleString('pt-BR') : 'Data indisponível'}</p>
                    `;
                    historyList.appendChild(item);
                });
            }
            historyModal.classList.remove('hidden');
        }

        // 'openSegmentModal' permanece a mesma
        async function openSegmentModal(sellerName) {
            currentSellerForSegment = sellerName;
            segmentModal.classList.remove('hidden');
            segmentModalSellerName.textContent = `Definir segmento para: ${sellerName}`;
            const currentSegment = sellerSegmentsCache[normalizeText(sellerName)] || "";
            segmentSelect.innerHTML = `<option value="">Selecione...</option>` + SEGMENTS.map(s => `<option value="${s}" ${currentSegment === s ? 'selected' : ''}>${s}</option>`).join('');
        }

        // 'loadAllSellerSegments' permanece a mesma
        async function loadAllSellerSegments() {
            // Agora usa sellerDataCache
            const uniqueSellers = [...new Set(Object.values(sellerDataCache).map(data => normalizeText(data.originalName)))];
            const sellersToFetch = uniqueSellers.filter(normalizedName => !sellerSegmentsCache.hasOwnProperty(normalizedName));
            
            if (sellersToFetch.length === 0) {
                 populateSegmentFilters();
                 return;
            }

            const fetchedConfigs = {};
            try {
                const q = collection(db, "vendedorConfig");
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    fetchedConfigs[doc.id] = doc.data().segmento;
                });
            } catch (error) {
                handleFirestoreError(error, "carregar configurações de segmento");
            }

            uniqueSellers.forEach(normalizedName => {
                sellerSegmentsCache[normalizedName] = fetchedConfigs[normalizedName] || null;
            });

            populateSegmentFilters();
        }

        // 'renderFeedbackDetails' permanece a mesma
        function renderFeedbackDetails(samples) {
            const lists = {
                approved: document.getElementById('approved-feedback-list'),
                rejected: document.getElementById('rejected-feedback-list'),
                events: document.getElementById('events-feedback-list'),
                pending: document.getElementById('pending-feedback-list')
            };

            Object.values(lists).forEach(list => { if(list) list.innerHTML = ''; });

            const counts = { approved: {}, rejected: {}, events: {}, pending: {} };

            const CANONICAL_APPROVED = ['COM PEDIDO', 'APROVADO SEM PEDIDO'];
            const CANONICAL_REJECTED = ['APRESENTAÇÃO PRÓ ATIVA', 'CALIBRE', 'EXTRAVIADA', 'FORA DA ESPECIFICAÇÃO DO CLIENTE', 'FORA DO PERFIL DO CLIENTE', 'FRACA / ESTOURANDO / COM CHUVEIRO', 'PRODUTO DESCONTINUADO', 'QUANTIDADE INSUFICIENTE', 'REPRESENTAÇÃO / DISTRIBUIDOR', 'SEM RETORNO DO CLIENTE', 'EXPORTACAO'];
            const CANONICAL_EVENTS = ['EVENTO'];
            const CANONICAL_PENDING = ['AMOSTRA NÃO TESTADA', 'EM ANÁLISE', 'AMOSTRA SEM FEEDBACK'];

            samples.forEach(sample => {
                 const feedback = sample.feedback ? sample.feedback.trim() : '';
                 if (feedback === '') {
                     let isSamplePending = sample.isPending;
                     if (typeof isSamplePending === 'undefined') {
                         isSamplePending = PENDING_STATUSES.includes(normalizeText(sample.originalStatus));
                     }
                     if(isSamplePending) {
                          counts.pending['PENDENTE (SISTEMA)'] = (counts.pending['PENDENTE (SISTEMA)'] || 0) + 1;
                     }
                     return;
                 }

                const canonicalFeedback = getCanonicalFeedback(feedback);
                let category = null;

                if (feedback.startsWith('A -') || CANONICAL_APPROVED.includes(canonicalFeedback)) category = 'approved';
                else if (feedback.startsWith('R -') || CANONICAL_REJECTED.includes(canonicalFeedback)) category = 'rejected';
                else if (feedback.startsWith('E -') || CANONICAL_EVENTS.includes(canonicalFeedback)) category = 'events';
                else if (feedback.startsWith('P -') || CANONICAL_PENDING.includes(canonicalFeedback)) category = 'pending';

                if (category) {
                    counts[category][canonicalFeedback] = (counts[category][canonicalFeedback] || 0) + 1;
                }
            });

            const renderList = (listElement, data) => {
                 if (!listElement) return;
                 const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);
                if (sortedData.length === 0) {
                     listElement.innerHTML = '<li>Nenhum feedback nesta categoria.</li>';
                     return;
                }
                listElement.innerHTML = sortedData.map(([text, count]) => `
                    <li>
                         <div class="flex justify-between items-center group">
                             <button class="feedback-item-btn text-left w-full hover:bg-gray-100 px-1 py-0.5 rounded flex justify-between items-center" data-feedback="${text}">
                                 <span>- ${text}</span>
                                 <span class="font-bold bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full ml-2">${count}</span>
                             </button>
                         </div>
                    </li>
                `).join('');
                 listElement.querySelectorAll('.feedback-item-btn').forEach(btn => {
                     btn.addEventListener('click', () => showFeedbackSamples(btn.dataset.feedback));
                 });
            };

            renderList(lists.approved, counts.approved);
            renderList(lists.rejected, counts.rejected);
            renderList(lists.events, counts.events);
            renderList(lists.pending, counts.pending);
        }

        // 'showFeedbackSamples' permanece a mesma
        function showFeedbackSamples(feedbackText, segmentFilter = '') {
            currentFeedbackFilter = feedbackText;
            const dataSource = [...allCurrentSamples, ...historicalAromaData];
            if (!dataSource || dataSource.length === 0) return;

            let filteredSamples = dataSource.filter(sample => {
                 if (feedbackText === 'PENDENTE (SISTEMA)') {
                     let isSamplePending = sample.isPending;
                     if (typeof isSamplePending === 'undefined') {
                         isSamplePending = PENDING_STATUSES.includes(normalizeText(sample.originalStatus));
                     }
                     return isSamplePending && (!sample.feedback || sample.feedback.trim() === '');
                 }
                return getCanonicalFeedback(sample.feedback) === feedbackText;
            });

            if (segmentFilter) {
                if (segmentFilter === AROMA_FILTER_VALUE) {
                    filteredSamples = filteredSamples.filter(sample => isAroma(sample.produto, sample.descricao));
                } else {
                    filteredSamples = filteredSamples.filter(sample => sellerSegmentsCache[normalizeText(sample.sellerName)] === segmentFilter);
                }
            }

            filteredSamples.sort((a, b) => {
                const isAHighlighted = !a.isHistorical && highlightedSamplesCache.includes(a.id);
                const isBHighlighted = !b.isHistorical && highlightedSamplesCache.includes(b.id);

                if (isAHighlighted && !isBHighlighted) return -1;
                if (!isAHighlighted && isBHighlighted) return 1;

                const nameCompare = a.sellerName.localeCompare(b.sellerName);
                if (nameCompare !== 0) return nameCompare;

                const secondaryA = a.pedido || a.produto || '';
                const secondaryB = b.pedido || b.produto || '';
                return secondaryA.localeCompare(secondaryB);
            });

            feedbackSamplesTitle.textContent = `Amostras com Feedback: "${feedbackText}" (${filteredSamples.length})`;
            feedbackSamplesList.innerHTML = '';

            if (filteredSamples.length === 0) {
                feedbackSamplesList.innerHTML = `<p class="text-gray-500">Nenhuma amostra encontrada ${segmentFilter ? (segmentFilter === AROMA_FILTER_VALUE ? 'do tipo Aroma' : `no segmento ${segmentFilter}`) : ''} com este feedback.</p>`;
            } else {
                filteredSamples.forEach(sample => {
                    const itemDiv = document.createElement('div');
                    const isHighlighted = !sample.isHistorical && highlightedSamplesCache.includes(sample.id);
                    const highlightClass = isHighlighted ? 'bg-amber-50 rounded-lg p-2' : '';
                    itemDiv.className = `feedback-sample-item text-sm ${highlightClass}`;

                     const managerReply = !sample.isHistorical ? allSellerReplies
                         .filter(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation)
                         .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0] : null;

                     let repliesHtml = '';
                     if (managerReply) {
                         const managerTime = managerReply.timestamp?.toDate() ? managerReply.timestamp.toDate().toLocaleString('pt-BR') : '';
                         repliesHtml += `<div class="manager-reply"><p><strong>${managerReply.managerName} respondeu:</strong> ${managerReply.replyMessage}</p><p class="text-xs text-gray-400 text-right">${managerTime}</p></div>`;
                         
                         const sellerOrPdReply = !sample.isHistorical ? allSellerRepliesToManager
                             .filter(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido && r.produto === sample.produto)
                             .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0] : null;
                         
                         if (sellerOrPdReply) {
                             const time = sellerOrPdReply.timestamp?.toDate() ? sellerOrPdReply.timestamp.toDate().toLocaleString('pt-BR') : '';
                             const isPDReply = sellerOrPdReply.originalManagerName === "P&D";
                             const senderName = isPDReply ? `${sellerOrPdReply.sellerName} (P&D)` : sellerOrPdReply.sellerName;
                             
                             repliesHtml += `<div class="seller-reply"><p><strong>${senderName} respondeu:</strong> ${sellerOrPdReply.replyMessage}</p><p class="text-xs text-gray-400 text-right">${time}</p></div>`;
                         }
                     }
                     const replyButtonHtml = (sample.observation && !sample.isHistorical) ? `<button class="reply-observation-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold ml-2" data-sample-id="${sample.id}">${managerReply ? 'Responder Novamente' : 'Responder'}</button>` : '';

                     const starIcon = isHighlighted ?
                         `<svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588 1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>` :
                         `<svg class="w-5 h-5 text-gray-400 hover:text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.524 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.524 4.674c.3.921-.755 1.688-1.54 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.539-1.118l1.524-4.674a1 1 0 00-.363-1.118L2.98 10.1c-.783-.57-.38-1.81.588 1.81h4.914a1 1 0 00.951-.69l1.524-4.674z"></path></svg>`;
                     const highlightButtonHtml = (sample.id && !sample.isHistorical) ? `<button class="highlight-sample-btn p-1 rounded-full hover:bg-gray-200" data-sample-id="${sample.id}" title="Destacar Amostra">${starIcon}</button>` : '';

                     itemDiv.innerHTML = `
                         <div class="flex justify-between items-start">
                             <div>
                                 <p class="font-semibold">${sample.produto}</p>
                                 ${sample.descricao ? `<p class="text-xs text-gray-600">${sample.descricao}</p>` : ''}
                                 <p>Pedido: ${sample.pedido || 'N/A'} <span class="text-gray-600">(${sample.razaoSocial || 'N/A'})</span></p>
                                 <p class="text-xs text-gray-500 mt-1">
                                     Vendedor: ${sample.sellerName} ${sample.emissaoNF ? `| NF: ${sample.emissaoNF}` : ''} ${sample.qtde ? `| Qtde: ${sample.qtde}` : ''}
                                     ${sample.isHistorical ? '<span class="font-bold text-blue-600 ml-1">(Histórico)</span>' : ''}
                                 </p>
                             </div>
                             <div class="flex items-center gap-1 flex-shrink-0">
                                 ${replyButtonHtml}
                                 ${highlightButtonHtml}
                             </div>
                         </div>
                         ${sample.observation ? `<p class="text-xs text-gray-600 mt-1 italic">Obs: ${sample.observation}</p>` : ''}
                         ${repliesHtml}
                     `;
                    feedbackSamplesList.appendChild(itemDiv);
                });
                 feedbackSamplesList.querySelectorAll('.reply-observation-btn').forEach(btn => {
                     btn.addEventListener('click', openReplyModal);
                 });
                 feedbackSamplesList.querySelectorAll('.highlight-sample-btn').forEach(btn => {
                     btn.addEventListener('click', toggleDestaqueAmostra);
                 });
            }
             if (feedbackSamplesModal.classList.contains('hidden')) {
                 populateModalSegmentFilter();
                 modalSegmentFilter.value = segmentFilter;
                 feedbackSamplesModal.classList.remove('hidden');
             }
        }

        // 'populateModalSegmentFilter' permanece a mesma
        function populateModalSegmentFilter() {
            const currentSegments = [...new Set(Object.values(sellerSegmentsCache).filter(Boolean))].sort();
            const currentValue = modalSegmentFilter.value;

            modalSegmentFilter.innerHTML = '<option value="">Todos os Segmentos</option>';
            const aromaOption = document.createElement('option');
            aromaOption.value = AROMA_FILTER_VALUE;
            aromaOption.textContent = 'Aromas (DAR / AROMAS)';
            modalSegmentFilter.appendChild(aromaOption);

            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '--- Segmentos ---';
            modalSegmentFilter.appendChild(separator);

            currentSegments.forEach(segment => {
                const option = document.createElement('option');
                option.value = segment;
                option.textContent = segment;
                modalSegmentFilter.appendChild(option);
            });

            if (modalSegmentFilter.querySelector(`option[value="${currentValue}"]`)) {
                modalSegmentFilter.value = currentValue;
            } else {
                modalSegmentFilter.value = "";
            }
        }

        // 'renderSegmentCharts' permanece a mesma
        function renderSegmentCharts(samples) {
            segmentChartsGrid.innerHTML = '';
            const samplesBySegment = {};

            samples.forEach(sample => {
                const segment = sellerSegmentsCache[normalizeText(sample.sellerName)];
                if (segment && !sample.isPending && sample.feedback && sample.feedback.trim() !== '') {
                     const canonicalFeedback = getCanonicalFeedback(sample.feedback);
                     const CANONICAL_PENDING = ['AMOSTRA NÃO TESTADA', 'EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'PENDENTE (SISTEMA)'];
                     if (CANONICAL_PENDING.includes(canonicalFeedback)) return;

                    if (!samplesBySegment[segment]) {
                        samplesBySegment[segment] = {};
                    }
                    samplesBySegment[segment][canonicalFeedback] = (samplesBySegment[segment][canonicalFeedback] || 0) + 1;
                }
            });

            if (Object.keys(samplesBySegment).length === 0) {
                segmentChartsGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full">Nenhum feedback finalizado por segmento para mostrar.</p>';
                return;
            }

            const segmentColors = generateColorPalette(Object.keys(SEGMENTS).length);

            Object.keys(samplesBySegment).sort().forEach(segment => {
                const chartId = `segment-chart-${segment.replace(/[\s/]+/g, '-')}`;
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-2xl shadow-sm border w-full';
                card.innerHTML = `<h3 class="font-bold text-lg mb-4 text-center">${segment}</h3><div class="relative" style="height:300px;"><canvas id="${chartId}"></canvas></div>`;
                segmentChartsGrid.appendChild(card);

                const labels = Object.keys(samplesBySegment[segment]);
                const data = Object.values(samplesBySegment[segment]);
                const color = segmentColors[SEGMENTS.indexOf(segment) % segmentColors.length];

                renderChart(chartId, 'bar', {
                    labels,
                    datasets: [{ data, backgroundColor: color }]
                }, {
                    indexAxis: 'y',
                    scales: {
                         x: { beginAtZero: true },
                         y: {
                             ticks: { autoSkip: false },
                             afterFit: function(scaleInstance) { scaleInstance.width = 220; }
                         }
                    },
                    plugins: { legend: { display: false } }
                });
            });
        }

        // 'generateColorPalette' permanece a mesma
        function generateColorPalette(numColors) {
            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444',
                '#6366f1', '#d946ef', '#f97316', '#22c55e', '#dc2626', '#38bdf8'
            ];
            let palette = [];
            for (let i = 0; i < numColors; i++) {
                palette.push(colors[i % colors.length]);
            }
            return palette;
        }

        // 'setupNotificationButton' permanece a mesma
        function setupNotificationButton() {
            if (!("Notification" in window)) {
                notificationsPermissionBtn.style.display = 'none';
                return;
            }
            switch(Notification.permission) {
                case 'granted':
                    bellIcon.classList.remove('text-gray-400', 'text-red-500');
                    bellIcon.classList.add('text-green-500');
                    notificationsPermissionBtn.title = 'Notificações estão ativadas.';
                    break;
                case 'denied':
                    bellIcon.classList.remove('text-gray-400', 'text-green-500');
                    bellIcon.classList.add('text-red-500');
                    notificationsPermissionBtn.title = 'Notificações bloqueadas.';
                    break;
                default:
                    bellIcon.classList.remove('text-green-500', 'text-red-500');
                    bellIcon.classList.add('text-gray-400');
                    notificationsPermissionBtn.title = 'Clique para ativar as notificações.';
            }
        }

        // 'showBrowserNotification' permanece a mesma
        function showBrowserNotification(title, body) {
            if (Notification.permission === 'granted') {
                 if(document.visibilityState === 'visible') {
                      console.log("Tab is active, skipping browser notification.");
                      return;
                 }
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/color/96/000000/appointment-reminders--v1.png'
                });
            }
        }

        // 'populateSegmentFilters' permanece a mesma
        function populateSegmentFilters() {
             const currentSegments = [...new Set(Object.values(sellerSegmentsCache).filter(Boolean))].sort();
             const obsSelect = document.getElementById('observation-segment-filter');
             const pdSelect = document.getElementById('pd-postit-segment-filter');

             const populateSelect = (selectEl) => {
                 if (!selectEl) return;
                 const currentValue = selectEl.value; 
                 selectEl.innerHTML = '<option value="">Todos os Segmentos</option>';
                 const aromaOption = document.createElement('option');
                 aromaOption.value = AROMA_FILTER_VALUE;
                 aromaOption.textContent = 'Aromas (DAR / AROMAS)';
                 selectEl.appendChild(aromaOption);
                 if (currentSegments.length > 0) {
                     const separator = document.createElement('option');
                     separator.disabled = true;
                     separator.textContent = '--- Segmentos ---';
                     selectEl.appendChild(separator);
                 }
                 currentSegments.forEach(segment => {
                     const option = document.createElement('option');
                     option.value = segment;
                     option.textContent = segment;
                     selectEl.appendChild(option);
                 });
                 if (selectEl.querySelector(`option[value="${currentValue}"]`)) {
                     selectEl.value = currentValue;
                 } else {
                     if (currentValue !== AROMA_FILTER_VALUE) {
                         selectEl.value = "";
                     } else {
                         selectEl.value = AROMA_FILTER_VALUE;
                     }
                 }
             };
             populateSelect(obsSelect);
             populateSelect(pdSelect);
             populateModalSegmentFilter();
        }

        // --- Initial Setup ---
        (async () => {
             try {
                 await signInAnonymously(auth);
                 listenForActiveSession();
                 setupNotificationButton();
             } catch (error) {
                 infoMessage.textContent = "Não foi possível conectar ao serviço.";
                 console.error("Firebase Auth Error:", error);
                 resetToInitialState();
             }
        })();
    </script>
</body>
</html>







































































































